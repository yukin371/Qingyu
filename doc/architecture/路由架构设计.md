# 路由架构设计

## 1. 概述

### 1.1 设计目标

本文档详细说明青羽书城前端基于Vue Router 4的路由架构设计，包括路由配置、导航守卫、权限控制等内容。

### 1.2 路由职责

- **页面导航**：控制应用的页面跳转
- **状态管理**：通过URL管理应用状态
- **权限控制**：实现页面级别的权限管理
- **数据预加载**：在路由切换时预加载数据
- **SEO优化**：支持服务端渲染和元信息管理

## 2. 路由架构设计

### 2.1 路由层次结构

```
/ (根路径)
├── / (首页)
├── /books (书籍列表)
│   └── /books/:id (书籍详情)
├── /rankings (榜单)
│   └── /rankings/:type (具体榜单)
├── /reader (阅读器)
│   └── /reader/:bookId/:chapterId (章节阅读)
├── /user (用户中心)
│   ├── /user/profile (个人信息)
│   ├── /user/bookshelf (我的书架)
│   └── /user/history (阅读历史)
└── /writer (写作端 - 独立应用)
```

### 2.2 路由配置文件结构

```
router/
├── index.js              # 主路由文件
├── routes/              # 路由配置
│   ├── home.js          # 首页路由
│   ├── books.js         # 书籍相关路由
│   ├── rankings.js      # 榜单路由
│   ├── reader.js        # 阅读器路由
│   └── user.js          # 用户中心路由
├── guards/              # 路由守卫
│   ├── auth.js          # 认证守卫
│   ├── permission.js    # 权限守卫
│   └── title.js         # 标题守卫
└── utils/               # 路由工具
    ├── scroll.js        # 滚动行为
    └── breadcrumb.js    # 面包屑生成
```

## 3. 路由配置实现

### 3.1 基础路由配置

```javascript
// router/index.js
import { createRouter, createWebHistory } from 'vue-router'
import { setupRouterGuards } from './guards'

// 导入路由配置
import homeRoutes from './routes/home'
import booksRoutes from './routes/books'
import rankingsRoutes from './routes/rankings'
import readerRoutes from './routes/reader'
import userRoutes from './routes/user'

const routes = [
  {
    path: '/',
    name: 'Layout',
    component: () => import('@/components/layout/MainLayout.vue'),
    children: [
      ...homeRoutes,
      ...booksRoutes,
      ...rankingsRoutes,
      ...userRoutes
    ]
  },
  // 阅读器使用独立布局
  ...readerRoutes,
  // 404页面
  {
    path: '/:pathMatch(.*)*',
    name: 'NotFound',
    component: () => import('@/views/NotFound.vue')
  }
]

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes,
  scrollBehavior(to, from, savedPosition) {
    if (savedPosition) {
      return savedPosition
    } else {
      return { top: 0 }
    }
  }
})

// 设置路由守卫
setupRouterGuards(router)

export default router
```

### 3.2 模块化路由配置

```javascript
// router/routes/books.js
export default [
  {
    path: '/books',
    name: 'BookList',
    component: () => import('@/views/books/BookListView.vue'),
    meta: {
      title: '书籍列表',
      requiresAuth: false,
      keepAlive: true
    }
  },
  {
    path: '/books/:id',
    name: 'BookDetail',
    component: () => import('@/views/books/BookDetailView.vue'),
    props: true,  // 将路由参数作为props传递
    meta: {
      title: '书籍详情',
      requiresAuth: false
    }
  }
]
```

```javascript
// router/routes/user.js
export default [
  {
    path: '/user',
    name: 'UserCenter',
    component: () => import('@/views/user/UserCenterView.vue'),
    meta: {
      title: '个人中心',
      requiresAuth: true,  // 需要登录
      icon: 'user'
    },
    children: [
      {
        path: 'profile',
        name: 'UserProfile',
        component: () => import('@/views/user/ProfileView.vue'),
        meta: {
          title: '个人信息',
          requiresAuth: true
        }
      },
      {
        path: 'bookshelf',
        name: 'UserBookshelf',
        component: () => import('@/views/user/BookshelfView.vue'),
        meta: {
          title: '我的书架',
          requiresAuth: true
        }
      },
      {
        path: 'history',
        name: 'UserHistory',
        component: () => import('@/views/user/HistoryView.vue'),
        meta: {
          title: '阅读历史',
          requiresAuth: true
        }
      }
    ]
  }
]
```

## 4. 路由守卫系统

### 4.1 守卫类型和执行顺序

```
全局前置守卫 (beforeEach)
    ↓
路由独享守卫 (beforeEnter)
    ↓
组件内守卫 (beforeRouteEnter)
    ↓
全局解析守卫 (beforeResolve)
    ↓
全局后置守卫 (afterEach)
```

### 4.2 认证守卫实现

```javascript
// router/guards/auth.js
import { useUserStore } from '@/stores/user'

export function setupAuthGuard(router) {
  router.beforeEach((to, from, next) => {
    const userStore = useUserStore()
    
    // 检查路由是否需要认证
    if (to.meta.requiresAuth) {
      // 检查用户是否已登录
      if (!userStore.isLoggedIn) {
        // 未登录，跳转到登录页
        next({
          name: 'Login',
          query: { redirect: to.fullPath }  // 保存目标路由
        })
      } else {
        // 已登录，继续
        next()
      }
    } else {
      // 不需要认证，直接通过
      next()
    }
  })
}
```

### 4.3 权限守卫实现

```javascript
// router/guards/permission.js
import { useUserStore } from '@/stores/user'
import { ElMessage } from 'element-plus'

export function setupPermissionGuard(router) {
  router.beforeEach((to, from, next) => {
    const userStore = useUserStore()
    
    // 检查路由是否需要特定权限
    if (to.meta.permissions) {
      const hasPermission = to.meta.permissions.some(permission => 
        userStore.hasPermission(permission)
      )
      
      if (!hasPermission) {
        ElMessage.error('您没有访问权限')
        next(from.path || '/')
      } else {
        next()
      }
    } else {
      next()
    }
  })
}
```

### 4.4 页面标题守卫

```javascript
// router/guards/title.js
const defaultTitle = '青羽书城'

export function setupTitleGuard(router) {
  router.afterEach((to) => {
    const title = to.meta.title
    document.title = title ? `${title} - ${defaultTitle}` : defaultTitle
  })
}
```

### 4.5 进度条守卫

```javascript
// router/guards/progress.js
import NProgress from 'nprogress'
import 'nprogress/nprogress.css'

NProgress.configure({ showSpinner: false })

export function setupProgressGuard(router) {
  router.beforeEach((to, from, next) => {
    NProgress.start()
    next()
  })
  
  router.afterEach(() => {
    NProgress.done()
  })
}
```

### 4.6 守卫组合

```javascript
// router/guards/index.js
import { setupAuthGuard } from './auth'
import { setupPermissionGuard } from './permission'
import { setupTitleGuard } from './title'
import { setupProgressGuard } from './progress'

export function setupRouterGuards(router) {
  // 按顺序设置守卫
  setupProgressGuard(router)
  setupAuthGuard(router)
  setupPermissionGuard(router)
  setupTitleGuard(router)
}
```

## 5. 路由元信息设计

### 5.1 元信息字段定义

```typescript
interface RouteMeta {
  title?: string           // 页面标题
  requiresAuth?: boolean   // 是否需要登录
  permissions?: string[]   // 需要的权限列表
  keepAlive?: boolean      // 是否缓存组件
  icon?: string           // 图标名称
  hidden?: boolean        // 是否在菜单中隐藏
  breadcrumb?: boolean    // 是否显示在面包屑中
  affix?: boolean         // 是否固定在标签栏
}
```

### 5.2 元信息使用示例

```javascript
{
  path: '/books/:id/edit',
  name: 'BookEdit',
  component: () => import('@/views/books/BookEditView.vue'),
  meta: {
    title: '编辑书籍',
    requiresAuth: true,
    permissions: ['book:edit', 'book:admin'],
    keepAlive: false,
    icon: 'edit',
    breadcrumb: true
  }
}
```

## 6. 路由懒加载策略

### 6.1 路由级别懒加载

```javascript
// ✅ 推荐：使用动态import
{
  path: '/books',
  component: () => import('@/views/books/BookListView.vue')
}

// ❌ 不推荐：直接import
import BookListView from '@/views/books/BookListView.vue'
{
  path: '/books',
  component: BookListView
}
```

### 6.2 路由分组懒加载

```javascript
// 将相关路由打包到同一个chunk
{
  path: '/user/profile',
  component: () => import(
    /* webpackChunkName: "user" */
    '@/views/user/ProfileView.vue'
  )
},
{
  path: '/user/settings',
  component: () => import(
    /* webpackChunkName: "user" */
    '@/views/user/SettingsView.vue'
  )
}
```

### 6.3 预加载关键路由

```javascript
// router/index.js
router.beforeEach((to, from, next) => {
  // 预加载下一个可能访问的页面
  if (to.name === 'BookList') {
    import('@/views/books/BookDetailView.vue')
  }
  next()
})
```

## 7. 路由过渡动画

### 7.1 基础过渡配置

```vue
<!-- App.vue -->
<template>
  <router-view v-slot="{ Component, route }">
    <transition :name="route.meta.transition || 'fade'" mode="out-in">
      <keep-alive :include="cachedViews">
        <component :is="Component" :key="route.path" />
      </keep-alive>
    </transition>
  </router-view>
</template>

<style>
/* fade过渡 */
.fade-enter-active, .fade-leave-active {
  transition: opacity 0.3s;
}
.fade-enter-from, .fade-leave-to {
  opacity: 0;
}

/* slide过渡 */
.slide-left-enter-active, .slide-left-leave-active {
  transition: all 0.3s;
}
.slide-left-enter-from {
  transform: translateX(30px);
  opacity: 0;
}
.slide-left-leave-to {
  transform: translateX(-30px);
  opacity: 0;
}
</style>
```

### 7.2 动态过渡效果

```javascript
// 根据路由层级决定过渡方向
router.beforeEach((to, from, next) => {
  const toDepth = to.path.split('/').length
  const fromDepth = from.path.split('/').length
  
  to.meta.transition = toDepth < fromDepth ? 'slide-right' : 'slide-left'
  next()
})
```

## 8. 滚动行为控制

### 8.1 自定义滚动行为

```javascript
const router = createRouter({
  history: createWebHistory(),
  routes,
  scrollBehavior(to, from, savedPosition) {
    // 1. 如果有保存的位置（浏览器后退）
    if (savedPosition) {
      return savedPosition
    }
    
    // 2. 如果有锚点
    if (to.hash) {
      return {
        el: to.hash,
        behavior: 'smooth'
      }
    }
    
    // 3. 默认滚动到顶部
    return { top: 0 }
  }
})
```

### 8.2 延迟滚动

```javascript
scrollBehavior(to, from, savedPosition) {
  return new Promise((resolve) => {
    setTimeout(() => {
      if (savedPosition) {
        resolve(savedPosition)
      } else {
        resolve({ top: 0 })
      }
    }, 300)  // 等待过渡动画完成
  })
}
```

## 9. 路由工具函数

### 9.1 面包屑生成

```javascript
// router/utils/breadcrumb.js
export function generateBreadcrumb(route) {
  const breadcrumbs = []
  
  route.matched.forEach(record => {
    if (record.meta.breadcrumb !== false) {
      breadcrumbs.push({
        name: record.meta.title,
        path: record.path,
        icon: record.meta.icon
      })
    }
  })
  
  return breadcrumbs
}
```

### 9.2 动态添加路由

```javascript
// 动态添加用户权限路由
export function addDynamicRoutes(router, userRoutes) {
  userRoutes.forEach(route => {
    router.addRoute(route)
  })
}

// 移除路由
export function removeRoute(router, routeName) {
  router.removeRoute(routeName)
}
```

### 9.3 路由缓存管理

```javascript
// stores/app.js
export const useAppStore = defineStore('app', {
  state: () => ({
    cachedViews: []
  }),
  
  actions: {
    addCachedView(view) {
      if (this.cachedViews.includes(view)) return
      if (view.meta?.keepAlive) {
        this.cachedViews.push(view.name)
      }
    },
    
    removeCachedView(view) {
      const index = this.cachedViews.indexOf(view.name)
      if (index > -1) {
        this.cachedViews.splice(index, 1)
      }
    },
    
    clearCachedViews() {
      this.cachedViews = []
    }
  }
})
```

## 10. 路由最佳实践

### 10.1 路由命名规范

```javascript
// ✅ 好的命名
{
  path: '/books/:id',
  name: 'BookDetail',        // PascalCase，清晰描述
  component: () => import('@/views/books/BookDetailView.vue')
}

// ❌ 不好的命名
{
  path: '/books/:id',
  name: 'book-detail',       // kebab-case
  name: 'detail',            // 不够具体
}
```

### 10.2 参数传递

```javascript
// 方式1：路径参数（推荐用于必需参数）
{
  path: '/books/:id',
  name: 'BookDetail',
  props: true  // 将params作为props传递
}

// 方式2：查询参数（推荐用于可选参数）
router.push({
  name: 'BookList',
  query: { category: 'fiction', page: 1 }
})

// 方式3：meta传递（推荐用于配置）
{
  path: '/admin',
  meta: { layout: 'admin', requiresAuth: true }
}
```

### 10.3 路由跳转封装

```javascript
// utils/navigation.js
import { useRouter } from 'vue-router'
import { ElMessage } from 'element-plus'

export function useNavigation() {
  const router = useRouter()
  
  // 安全跳转（带错误处理）
  const safePush = async (to) => {
    try {
      await router.push(to)
    } catch (error) {
      if (error.name !== 'NavigationDuplicated') {
        ElMessage.error('导航失败')
        console.error('Navigation error:', error)
      }
    }
  }
  
  // 带确认的跳转
  const confirmPush = async (to, message = '确定要离开吗？') => {
    if (confirm(message)) {
      await safePush(to)
    }
  }
  
  return {
    safePush,
    confirmPush
  }
}
```

## 11. 路由性能优化

### 11.1 路由预加载

```javascript
// 鼠标悬停时预加载
router.beforeEach((to, from, next) => {
  const links = document.querySelectorAll('a[href]')
  
  links.forEach(link => {
    link.addEventListener('mouseenter', () => {
      const href = link.getAttribute('href')
      const route = router.resolve(href)
      
      if (route.matched.length) {
        route.matched.forEach(record => {
          record.components?.default?.()
        })
      }
    })
  })
  
  next()
})
```

### 11.2 路由缓存策略

```vue
<template>
  <router-view v-slot="{ Component }">
    <keep-alive :include="cachedViews" :max="10">
      <component :is="Component" />
    </keep-alive>
  </router-view>
</template>

<script setup>
import { computed } from 'vue'
import { useAppStore } from '@/stores/app'

const app = useAppStore()
const cachedViews = computed(() => app.cachedViews)
</script>
```

## 12. 路由调试

### 12.1 路由日志

```javascript
router.beforeEach((to, from) => {
  if (import.meta.env.DEV) {
    console.log('路由跳转:', {
      from: from.fullPath,
      to: to.fullPath,
      meta: to.meta
    })
  }
})
```

### 12.2 路由错误处理

```javascript
router.onError((error) => {
  console.error('路由错误:', error)
  
  // 上报错误
  if (import.meta.env.PROD) {
    // 发送到错误监控服务
  }
})
```

## 13. 参考资料

- [Vue Router 4 官方文档](https://router.vuejs.org/)
- [导航守卫详解](https://router.vuejs.org/guide/advanced/navigation-guards.html)
- [路由懒加载](https://router.vuejs.org/guide/advanced/lazy-loading.html)

---

**文档版本**：v1.0.0  
**创建时间**：2025年10月13日  
**最后更新**：2025年10月13日  
**维护者**：前端架构师

