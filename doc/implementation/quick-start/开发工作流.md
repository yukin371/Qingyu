# 开发工作流指南

## 1. 概述

本文档详细说明青羽书城前端项目的日常开发工作流程，包括分支管理、代码提交、Code Review等环节。

### 1.1 工作流程概览

```
需求分析 → 创建分支 → 编写代码 → 本地测试 → 提交代码 → Code Review → 合并主分支 → 部署上线
```

## 2. Git 分支策略

### 2.1 分支类型

我们采用 **Git Flow** 分支管理策略：

```
main (主分支)
  └── develop (开发分支)
        ├── feature/xxx (功能分支)
        ├── bugfix/xxx (bug修复分支)
        ├── hotfix/xxx (紧急修复分支)
        └── release/xxx (发布分支)
```

#### 分支说明

| 分支类型 | 命名规则 | 生命周期 | 说明 |
|---------|---------|---------|------|
| **main** | main | 永久 | 生产环境代码 |
| **develop** | develop | 永久 | 开发环境代码 |
| **feature** | feature/功能名 | 临时 | 新功能开发 |
| **bugfix** | bugfix/问题描述 | 临时 | Bug修复 |
| **hotfix** | hotfix/问题描述 | 临时 | 紧急线上修复 |
| **release** | release/版本号 | 临时 | 发布准备 |

### 2.2 分支创建和切换

#### 创建功能分支

```bash
# 1. 确保在develop分支
git checkout develop

# 2. 拉取最新代码
git pull origin develop

# 3. 创建并切换到新分支
git checkout -b feature/user-login

# 或使用一行命令
git pull origin develop && git checkout -b feature/user-login
```

#### 分支命名规范

```bash
# ✅ 好的命名
feature/user-authentication
feature/book-search
bugfix/login-error
hotfix/payment-crash

# ❌ 不好的命名
feature/test
my-branch
update
fix
```

## 3. 日常开发流程

### 3.1 开始新任务

```bash
# Step 1: 获取最新代码
git checkout develop
git pull origin develop

# Step 2: 创建功能分支
git checkout -b feature/book-detail-page

# Step 3: 开始开发
code .  # 打开VS Code
```

### 3.2 编写代码

#### 开发规范

1. **组件开发**
   ```vue
   <template>
     <div class="book-detail">
       <!-- 组件内容 -->
     </div>
   </template>
   
   <script setup>
   // 遵循组件开发规范
   </script>
   
   <style scoped>
   /* 使用BEM命名 */
   .book-detail { }
   .book-detail__title { }
   </style>
   ```

2. **API调用**
   ```javascript
   // api/books.js
   export const booksAPI = {
     getDetail(id) {
       return api.get(`/books/${id}`)
     }
   }
   ```

3. **状态管理**
   ```javascript
   // stores/books.js
   export const useBooksStore = defineStore('books', {
     state: () => ({
       currentBook: null
     }),
     actions: {
       async fetchBookDetail(id) {
         // 获取书籍详情
       }
     }
   })
   ```

### 3.3 本地测试

```bash
# 启动开发服务器
pnpm dev

# 在浏览器中测试功能
# http://localhost:5173

# 运行单元测试
pnpm test

# 运行代码检查
pnpm lint
```

### 3.4 查看修改

```bash
# 查看修改的文件
git status

# 查看具体修改内容
git diff

# 查看某个文件的修改
git diff src/views/BookDetail.vue
```

## 4. 代码提交

### 4.1 提交规范

我们使用 **Conventional Commits** 规范：

```
<type>(<scope>): <subject>

<body>

<footer>
```

#### Type 类型

| 类型 | 说明 | 示例 |
|------|------|------|
| **feat** | 新功能 | feat(books): 添加书籍详情页 |
| **fix** | Bug修复 | fix(login): 修复登录失败问题 |
| **docs** | 文档更新 | docs(readme): 更新安装说明 |
| **style** | 代码格式 | style(css): 优化按钮样式 |
| **refactor** | 重构 | refactor(api): 重构API调用逻辑 |
| **perf** | 性能优化 | perf(list): 优化列表渲染性能 |
| **test** | 测试 | test(books): 添加书籍测试用例 |
| **chore** | 构建/工具 | chore(deps): 更新依赖版本 |
| **ci** | CI配置 | ci(github): 更新CI配置 |
| **revert** | 回滚 | revert: 回滚xxx提交 |

#### Scope 范围（可选）

常用的scope：
- `components` - 组件相关
- `views` - 页面相关
- `api` - API相关
- `stores` - 状态管理
- `router` - 路由
- `utils` - 工具函数
- `styles` - 样式

### 4.2 提交步骤

```bash
# Step 1: 添加修改的文件
git add src/views/BookDetail.vue
git add src/api/books.js
git add src/stores/books.js

# 或添加所有修改
git add .

# Step 2: 提交代码
git commit -m "feat(books): 添加书籍详情页

- 实现书籍详情展示组件
- 添加书籍详情API接口
- 实现书籍详情状态管理"

# Step 3: 推送到远程
git push origin feature/book-detail-page
```

### 4.3 提交示例

#### 好的提交消息

```bash
✅ feat(books): 添加书籍详情页
✅ fix(login): 修复Token过期导致的登录失败
✅ docs(api): 更新API文档
✅ style(layout): 调整页面布局样式
✅ refactor(utils): 重构日期格式化工具
✅ perf(list): 使用虚拟滚动优化长列表性能
```

#### 不好的提交消息

```bash
❌ update code
❌ fix bug
❌ 修改
❌ test
❌ wip (work in progress)
```

### 4.4 Commitlint 配置

项目配置了commitlint，会自动检查提交消息格式：

```javascript
// commitlint.config.js
module.exports = {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'type-enum': [
      2,
      'always',
      [
        'feat', 'fix', 'docs', 'style', 'refactor',
        'perf', 'test', 'chore', 'ci', 'revert'
      ]
    ],
    'subject-case': [0]
  }
}
```

## 5. Code Review 流程

### 5.1 创建 Pull Request

```bash
# Step 1: 确保代码已推送
git push origin feature/book-detail-page

# Step 2: 在GitHub/GitLab上创建PR
# - 选择: feature/book-detail-page -> develop
# - 填写PR标题和描述
# - 指定审查人员
```

### 5.2 PR 模板

**标题**：
```
feat(books): 添加书籍详情页
```

**描述**：
```markdown
## 📝 变更说明
实现书籍详情页面，包括：
- 书籍基本信息展示
- 章节列表
- 评论功能

## 🎯 相关Issue
Closes #123

## 📸 截图（如有）
![书籍详情页](./screenshot.png)

## ✅ 检查清单
- [x] 代码符合ESLint规范
- [x] 已添加单元测试
- [x] 已在本地测试通过
- [x] 已更新相关文档
```

### 5.3 Code Review 要点

#### 审查者检查清单

- [ ] **代码质量**
  - 代码逻辑是否清晰
  - 是否有明显的bug
  - 是否遵循项目规范

- [ ] **性能考虑**
  - 是否有性能问题
  - 是否需要优化

- [ ] **安全性**
  - 是否有安全隐患
  - 敏感信息是否保护

- [ ] **测试覆盖**
  - 是否有足够的测试用例
  - 测试是否通过

- [ ] **文档完整性**
  - 是否需要更新文档
  - 注释是否清晰

### 5.4 处理Review意见

```bash
# Step 1: 根据意见修改代码

# Step 2: 提交修改
git add .
git commit -m "fix(books): 根据review意见优化代码"

# Step 3: 推送更新
git push origin feature/book-detail-page

# PR会自动更新
```

## 6. 合并代码

### 6.1 合并前检查

```bash
# Step 1: 同步develop最新代码
git checkout develop
git pull origin develop

# Step 2: 切回功能分支
git checkout feature/book-detail-page

# Step 3: 合并develop到功能分支（处理冲突）
git merge develop

# Step 4: 解决冲突（如果有）
# 编辑冲突文件，解决冲突

# Step 5: 提交合并
git add .
git commit -m "merge: 合并develop分支"
git push origin feature/book-detail-page
```

### 6.2 合并策略

#### Merge（保留完整历史）
```bash
git checkout develop
git merge --no-ff feature/book-detail-page
```

#### Squash（合并为单个提交）
```bash
git checkout develop
git merge --squash feature/book-detail-page
git commit -m "feat(books): 添加书籍详情页"
```

#### Rebase（线性历史）
```bash
git checkout feature/book-detail-page
git rebase develop
git push -f origin feature/book-detail-page
```

### 6.3 删除分支

```bash
# 删除本地分支
git branch -d feature/book-detail-page

# 删除远程分支
git push origin --delete feature/book-detail-page
```

## 7. 冲突解决

### 7.1 识别冲突

```bash
# 合并时出现冲突
git merge develop

# 输出：
Auto-merging src/views/BookDetail.vue
CONFLICT (content): Merge conflict in src/views/BookDetail.vue
Automatic merge failed; fix conflicts and then commit the result.
```

### 7.2 解决冲突

```vue
<!-- 冲突标记 -->
<<<<<<< HEAD
<div class="book-detail">
  <!-- 你的代码 -->
</div>
=======
<div class="book-info">
  <!-- 他人的代码 -->
</div>
>>>>>>> develop

<!-- 解决后 -->
<div class="book-detail">
  <!-- 合并后的代码 -->
</div>
```

### 7.3 提交解决

```bash
# Step 1: 编辑冲突文件，解决冲突

# Step 2: 标记为已解决
git add src/views/BookDetail.vue

# Step 3: 继续合并
git merge --continue

# 或提交
git commit -m "merge: 解决合并冲突"
```

### 7.4 使用工具解决冲突

```bash
# 使用VS Code
# 在冲突文件中会显示：
# - Accept Current Change
# - Accept Incoming Change
# - Accept Both Changes
# - Compare Changes

# 使用Git合并工具
git mergetool
```

## 8. 常用Git命令

### 8.1 查看状态

```bash
# 查看工作区状态
git status

# 查看提交历史
git log

# 简洁的提交历史
git log --oneline --graph --decorate

# 查看某个文件的历史
git log -- src/views/BookDetail.vue
```

### 8.2 撤销操作

```bash
# 撤销工作区修改
git checkout -- <file>

# 撤销暂存区修改
git reset HEAD <file>

# 撤销最后一次提交（保留修改）
git reset --soft HEAD^

# 撤销最后一次提交（不保留修改）
git reset --hard HEAD^

# 撤销某次提交
git revert <commit-hash>
```

### 8.3 储藏修改

```bash
# 储藏当前修改
git stash

# 查看储藏列表
git stash list

# 应用最新储藏
git stash apply

# 应用并删除储藏
git stash pop

# 删除储藏
git stash drop
```

### 8.4 标签管理

```bash
# 创建标签
git tag v1.0.0

# 创建带说明的标签
git tag -a v1.0.0 -m "版本1.0.0发布"

# 推送标签
git push origin v1.0.0

# 推送所有标签
git push origin --tags

# 删除标签
git tag -d v1.0.0
git push origin :refs/tags/v1.0.0
```

## 9. 持续集成（CI）

### 9.1 GitHub Actions

项目配置了自动化CI流程：

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - run: pnpm install
      - run: pnpm lint
      - run: pnpm test
      - run: pnpm build
```

### 9.2 Pre-commit Hooks

使用Husky配置提交前检查：

```json
// package.json
{
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged",
      "commit-msg": "commitlint -E HUSKY_GIT_PARAMS"
    }
  },
  "lint-staged": {
    "*.{js,vue}": [
      "eslint --fix",
      "prettier --write"
    ]
  }
}
```

## 10. 发布流程

### 10.1 准备发布

```bash
# Step 1: 创建release分支
git checkout develop
git checkout -b release/v1.0.0

# Step 2: 更新版本号
npm version minor  # 1.0.0 -> 1.1.0

# Step 3: 更新CHANGELOG
# 编辑 CHANGELOG.md

# Step 4: 提交
git add .
git commit -m "chore(release): 准备发布v1.1.0"
```

### 10.2 合并到主分支

```bash
# Step 1: 合并到main
git checkout main
git merge --no-ff release/v1.0.0

# Step 2: 打标签
git tag -a v1.0.0 -m "Release v1.0.0"

# Step 3: 合并回develop
git checkout develop
git merge --no-ff release/v1.0.0

# Step 4: 推送
git push origin main develop --tags

# Step 5: 删除release分支
git branch -d release/v1.0.0
```

## 11. 最佳实践

### 11.1 提交原则

- ✅ **小而频繁**：每个提交只包含一个逻辑变更
- ✅ **清晰描述**：提交信息准确描述变更内容
- ✅ **可测试**：每次提交后代码都能正常运行
- ✅ **可回滚**：每个提交都是独立可回滚的

### 11.2 分支管理

- ✅ **及时清理**：合并后及时删除分支
- ✅ **定期同步**：定期从develop同步最新代码
- ✅ **避免长期分支**：功能分支不要存在太久

### 11.3 代码审查

- ✅ **及时响应**：尽快回复PR的评论
- ✅ **建设性反馈**：提供具体的改进建议
- ✅ **学习心态**：将review作为学习机会

## 12. 问题排查

### 12.1 常见问题

**问题1：推送被拒绝**
```bash
# 原因：远程有新提交
# 解决：先拉取再推送
git pull origin feature/xxx --rebase
git push origin feature/xxx
```

**问题2：提交到错误分支**
```bash
# 解决：移动提交到正确分支
git log  # 找到commit hash
git checkout correct-branch
git cherry-pick <commit-hash>
```

**问题3：误删文件**
```bash
# 恢复文件
git checkout HEAD -- <file>
```

## 13. 参考资料

- [Git官方文档](https://git-scm.com/doc)
- [Git Flow工作流](https://nvie.com/posts/a-successful-git-branching-model/)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [语义化版本](https://semver.org/)

---

**文档版本**：v1.0.0  
**创建时间**：2025年10月13日  
**最后更新**：2025年10月13日  
**维护者**：前端团队

