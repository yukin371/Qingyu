# 页面开发指南

## 1. 概述

本文档详细说明如何在青羽书城前端项目中开发页面组件，包括页面结构、数据获取、状态管理等完整流程。

### 1.1 页面开发流程

```
需求分析 → 路由配置 → 页面结构设计 → 数据获取 → 状态管理 → UI实现 → 测试验证
```

## 2. 创建页面

### 2.1 页面文件结构

**单文件页面**（简单页面）：
```
src/views/BookDetail.vue
```

**多文件页面**（复杂页面）：
```
src/views/BookDetail/
├── index.vue              # 主页面
├── components/            # 页面专用组件
│   ├── BookInfo.vue
│   ├── ChapterList.vue
│   └── CommentSection.vue
├── hooks/                 # 页面专用hooks
│   └── useBookDetail.js
└── BookDetail.test.js     # 测试文件
```

### 2.2 基础页面模板

```vue
<!-- src/views/BookDetail.vue -->
<template>
  <div class="book-detail-page">
    <!-- 加载状态 -->
    <div v-if="loading" class="loading">
      <el-skeleton :rows="5" animated />
    </div>
    
    <!-- 错误状态 -->
    <div v-else-if="error" class="error">
      <el-empty description="加载失败">
        <el-button @click="fetchData">重试</el-button>
      </el-empty>
    </div>
    
    <!-- 内容展示 -->
    <div v-else-if="book" class="content">
      <!-- 书籍信息 -->
      <section class="book-info">
        <img :src="book.cover" :alt="book.title" />
        <div class="info">
          <h1>{{ book.title }}</h1>
          <p>作者：{{ book.author }}</p>
          <p>分类：{{ book.category }}</p>
          <div class="actions">
            <el-button type="primary" @click="startReading">
              开始阅读
            </el-button>
            <el-button @click="toggleFavorite">
              {{ isFavorited ? '已收藏' : '收藏' }}
            </el-button>
          </div>
        </div>
      </section>
      
      <!-- 章节列表 -->
      <section class="chapters">
        <h2>章节目录</h2>
        <ChapterList :chapters="book.chapters" />
      </section>
      
      <!-- 评论区 -->
      <section class="comments">
        <h2>书籍评论</h2>
        <CommentSection :book-id="book.id" />
      </section>
    </div>
    
    <!-- 空状态 -->
    <div v-else class="empty">
      <el-empty description="书籍不存在" />
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { useBooksStore } from '@/stores/books'
import { useUserStore } from '@/stores/user'
import ChapterList from './components/ChapterList.vue'
import CommentSection from './components/CommentSection.vue'

/**
 * 书籍详情页
 * @route /books/:id
 */

const route = useRoute()
const router = useRouter()
const booksStore = useBooksStore()
const userStore = useUserStore()

// 页面状态
const loading = ref(false)
const error = ref(null)
const book = ref(null)

// 计算属性
const isFavorited = computed(() => {
  return userStore.favoriteBooks.includes(book.value?.id)
})

// 获取数据
const fetchData = async () => {
  loading.value = true
  error.value = null
  
  try {
    const bookId = route.params.id
    book.value = await booksStore.fetchBookDetail(bookId)
  } catch (err) {
    error.value = err.message
    console.error('获取书籍详情失败:', err)
  } finally {
    loading.value = false
  }
}

// 方法
const startReading = () => {
  if (book.value.chapters.length > 0) {
    router.push(`/reader/${book.value.id}/${book.value.chapters[0].id}`)
  }
}

const toggleFavorite = async () => {
  try {
    await userStore.toggleFavorite(book.value.id)
  } catch (err) {
    ElMessage.error('操作失败')
  }
}

// 生命周期
onMounted(() => {
  fetchData()
})

// 监听路由变化
watch(() => route.params.id, () => {
  if (route.params.id) {
    fetchData()
  }
})
</script>

<style scoped>
.book-detail-page {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.book-info {
  display: flex;
  gap: 40px;
  margin-bottom: 40px;
}

.book-info img {
  width: 300px;
  height: 400px;
  object-fit: cover;
  border-radius: 8px;
}

.info h1 {
  font-size: 32px;
  margin-bottom: 16px;
}

.actions {
  display: flex;
  gap: 12px;
  margin-top: 24px;
}

section {
  margin-bottom: 40px;
}

section h2 {
  font-size: 24px;
  margin-bottom: 20px;
}
</style>
```

## 3. 路由配置

### 3.1 添加路由

```javascript
// router/routes/books.js
export default [
  {
    path: '/books/:id',
    name: 'BookDetail',
    component: () => import('@/views/BookDetail.vue'),
    props: true,  // 将params作为props传递
    meta: {
      title: '书籍详情',
      requiresAuth: false,
      keepAlive: false
    }
  }
]
```

### 3.2 路由参数处理

```vue
<script setup>
// 方式1：使用useRoute
import { useRoute } from 'vue-router'
const route = useRoute()
const bookId = route.params.id

// 方式2：使用props（推荐）
const props = defineProps({
  id: {
    type: String,
    required: true
  }
})
</script>
```

### 3.3 路由守卫

```javascript
// 页面级守卫
<script setup>
import { onBeforeRouteLeave } from 'vue-router'

// 离开页面前确认
onBeforeRouteLeave((to, from) => {
  if (hasUnsavedChanges.value) {
    const answer = window.confirm('有未保存的更改，确定要离开吗？')
    if (!answer) return false
  }
})
</script>
```

## 4. 数据获取

### 4.1 使用Store获取数据

```vue
<script setup>
import { useBooksStore } from '@/stores/books'

const booksStore = useBooksStore()
const loading = ref(false)
const error = ref(null)

const fetchBooks = async () => {
  loading.value = true
  try {
    await booksStore.fetchBooks({ page: 1, size: 20 })
  } catch (err) {
    error.value = err.message
  } finally {
    loading.value = false
  }
}

onMounted(() => {
  fetchBooks()
})
</script>
```

### 4.2 直接调用API

```vue
<script setup>
import { booksAPI } from '@/api/books'

const books = ref([])
const loading = ref(false)

const fetchBooks = async () => {
  loading.value = true
  try {
    const response = await booksAPI.getList({ page: 1 })
    books.value = response.data
  } catch (error) {
    console.error(error)
  } finally {
    loading.value = false
  }
}
</script>
```

### 4.3 使用Composables封装

```javascript
// hooks/useBookList.js
import { ref } from 'vue'
import { booksAPI } from '@/api/books'

export function useBookList() {
  const books = ref([])
  const loading = ref(false)
  const error = ref(null)
  const pagination = ref({
    page: 1,
    size: 20,
    total: 0
  })

  const fetchBooks = async (params = {}) => {
    loading.value = true
    error.value = null
    
    try {
      const response = await booksAPI.getList({
        page: pagination.value.page,
        size: pagination.value.size,
        ...params
      })
      
      books.value = response.data
      pagination.value.total = response.total
    } catch (err) {
      error.value = err.message
      throw err
    } finally {
      loading.value = false
    }
  }

  const nextPage = () => {
    pagination.value.page++
    fetchBooks()
  }

  const prevPage = () => {
    if (pagination.value.page > 1) {
      pagination.value.page--
      fetchBooks()
    }
  }

  return {
    books,
    loading,
    error,
    pagination,
    fetchBooks,
    nextPage,
    prevPage
  }
}
```

```vue
<!-- 在页面中使用 -->
<script setup>
import { useBookList } from '@/hooks/useBookList'

const {
  books,
  loading,
  error,
  pagination,
  fetchBooks,
  nextPage,
  prevPage
} = useBookList()

onMounted(() => {
  fetchBooks()
})
</script>
```

## 5. 状态管理

### 5.1 页面级状态

```vue
<script setup>
// 页面内部状态
const currentTab = ref('info')
const showModal = ref(false)
const formData = ref({
  name: '',
  email: ''
})
</script>
```

### 5.2 全局状态

```vue
<script setup>
import { useAppStore } from '@/stores/app'
import { storeToRefs } from 'pinia'

const appStore = useAppStore()

// 使用storeToRefs保持响应性
const { theme, sidebarCollapsed } = storeToRefs(appStore)

// 直接调用actions
const { setTheme, toggleSidebar } = appStore
</script>
```

## 6. 页面布局

### 6.1 使用布局组件

```vue
<template>
  <MainLayout>
    <template #header>
      <PageHeader :title="book.title" />
    </template>
    
    <template #default>
      <!-- 页面内容 -->
    </template>
    
    <template #aside>
      <RecommendBooks />
    </template>
  </MainLayout>
</template>
```

### 6.2 响应式布局

```vue
<template>
  <div class="page">
    <!-- 桌面端布局 -->
    <div v-if="!isMobile" class="desktop-layout">
      <aside class="sidebar">侧边栏</aside>
      <main class="content">主内容</main>
    </div>
    
    <!-- 移动端布局 -->
    <div v-else class="mobile-layout">
      <main class="content">主内容</main>
      <el-drawer v-model="showSidebar">
        <aside class="sidebar">侧边栏</aside>
      </el-drawer>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue'

const isMobile = ref(false)

const checkDevice = () => {
  isMobile.value = window.innerWidth < 768
}

onMounted(() => {
  checkDevice()
  window.addEventListener('resize', checkDevice)
})

onUnmounted(() => {
  window.removeEventListener('resize', checkDevice)
})
</script>
```

## 7. 表单处理

### 7.1 表单验证

```vue
<template>
  <el-form 
    ref="formRef"
    :model="formData"
    :rules="rules"
    label-width="120px"
  >
    <el-form-item label="书名" prop="title">
      <el-input v-model="formData.title" />
    </el-form-item>
    
    <el-form-item label="作者" prop="author">
      <el-input v-model="formData.author" />
    </el-form-item>
    
    <el-form-item>
      <el-button type="primary" @click="submitForm">提交</el-button>
      <el-button @click="resetForm">重置</el-button>
    </el-form-item>
  </el-form>
</template>

<script setup>
import { ref, reactive } from 'vue'

const formRef = ref(null)

const formData = reactive({
  title: '',
  author: ''
})

const rules = {
  title: [
    { required: true, message: '请输入书名', trigger: 'blur' },
    { min: 2, max: 50, message: '长度在2到50个字符', trigger: 'blur' }
  ],
  author: [
    { required: true, message: '请输入作者', trigger: 'blur' }
  ]
}

const submitForm = async () => {
  try {
    await formRef.value.validate()
    // 提交表单
    console.log('表单数据:', formData)
  } catch (error) {
    console.error('验证失败:', error)
  }
}

const resetForm = () => {
  formRef.value.resetFields()
}
</script>
```

## 8. 列表页面

### 8.1 列表渲染

```vue
<template>
  <div class="book-list-page">
    <!-- 筛选条件 -->
    <div class="filters">
      <el-select v-model="filters.category" placeholder="选择分类">
        <el-option 
          v-for="cat in categories" 
          :key="cat.id"
          :label="cat.name"
          :value="cat.id"
        />
      </el-select>
      
      <el-input 
        v-model="filters.keyword"
        placeholder="搜索书籍"
        @change="handleSearch"
      />
    </div>
    
    <!-- 书籍列表 -->
    <div v-if="loading" class="loading">
      <el-skeleton :rows="5" animated />
    </div>
    
    <div v-else-if="books.length > 0" class="book-grid">
      <BookCard 
        v-for="book in books"
        :key="book.id"
        :book="book"
        @click="handleBookClick"
      />
    </div>
    
    <el-empty v-else description="暂无数据" />
    
    <!-- 分页 -->
    <el-pagination
      v-model:current-page="pagination.page"
      v-model:page-size="pagination.size"
      :total="pagination.total"
      :page-sizes="[10, 20, 50, 100]"
      layout="total, sizes, prev, pager, next, jumper"
      @current-change="handlePageChange"
      @size-change="handleSizeChange"
    />
  </div>
</template>

<script setup>
import { ref, reactive, watch } from 'vue'
import { useBookList } from '@/hooks/useBookList'
import BookCard from '@/components/BookCard.vue'

const { books, loading, pagination, fetchBooks } = useBookList()

const filters = reactive({
  category: '',
  keyword: ''
})

const handleSearch = () => {
  pagination.page = 1
  fetchBooks(filters)
}

const handlePageChange = (page) => {
  fetchBooks(filters)
}

const handleSizeChange = (size) => {
  pagination.page = 1
  fetchBooks(filters)
}

const handleBookClick = (book) => {
  router.push(`/books/${book.id}`)
}

// 监听筛选条件变化
watch(
  () => filters.category,
  () => handleSearch()
)

onMounted(() => {
  fetchBooks()
})
</script>
```

## 9. SEO优化

### 9.1 设置页面标题

```vue
<script setup>
import { useHead } from '@vueuse/head'

useHead({
  title: computed(() => `${book.value?.title} - 青羽书城`),
  meta: [
    {
      name: 'description',
      content: computed(() => book.value?.description)
    },
    {
      property: 'og:title',
      content: computed(() => book.value?.title)
    }
  ]
})
</script>
```

### 9.2 动态路由元信息

```javascript
// 在路由守卫中设置
router.beforeEach((to, from, next) => {
  if (to.meta.title) {
    document.title = `${to.meta.title} - 青羽书城`
  }
  next()
})
```

## 10. 性能优化

### 10.1 组件懒加载

```vue
<script setup>
import { defineAsyncComponent } from 'vue'

const CommentSection = defineAsyncComponent(() =>
  import('./components/CommentSection.vue')
)
</script>
```

### 10.2 虚拟滚动

```vue
<template>
  <RecycleScroller
    :items="books"
    :item-size="200"
    key-field="id"
    v-slot="{ item }"
  >
    <BookCard :book="item" />
  </RecycleScroller>
</template>
```

### 10.3 防抖搜索

```vue
<script setup>
import { useDebounceFn } from '@vueuse/core'

const searchKeyword = ref('')

const handleSearch = useDebounceFn(() => {
  fetchBooks({ keyword: searchKeyword.value })
}, 500)
</script>
```

## 11. 错误处理

### 11.1 错误边界

```vue
<script setup>
import { onErrorCaptured } from 'vue'

const error = ref(null)

onErrorCaptured((err, instance, info) => {
  error.value = {
    message: err.message,
    info
  }
  
  console.error('页面错误:', err)
  return false  // 阻止错误继续传播
})
</script>

<template>
  <div v-if="error" class="error-boundary">
    <h2>页面出错了</h2>
    <p>{{ error.message }}</p>
    <el-button @click="reload">刷新页面</el-button>
  </div>
  
  <div v-else>
    <!-- 正常内容 -->
  </div>
</template>
```

## 12. 最佳实践

### 12.1 页面结构

```vue
<template>
  <div class="page-container">
    <!-- 1. 页面头部 -->
    <header class="page-header">
      <h1>{{ pageTitle }}</h1>
      <div class="actions">
        <!-- 操作按钮 -->
      </div>
    </header>
    
    <!-- 2. 筛选条件（如果有） -->
    <div class="page-filters">
      <!-- 筛选组件 -->
    </div>
    
    <!-- 3. 主要内容 -->
    <main class="page-content">
      <!-- 内容区域 -->
    </main>
    
    <!-- 4. 分页（如果有） -->
    <footer class="page-footer">
      <!-- 分页组件 -->
    </footer>
  </div>
</template>
```

### 12.2 代码组织

```javascript
<script setup>
// 1. 导入
import { ref, computed, onMounted } from 'vue'
import { useRoute } from 'vue-router'

// 2. Props和Emits
const props = defineProps({})
const emit = defineEmits([])

// 3. 路由和Store
const route = useRoute()
const store = useStore()

// 4. 响应式数据
const loading = ref(false)
const data = ref(null)

// 5. 计算属性
const processedData = computed(() => {})

// 6. 方法
const fetchData = async () => {}

// 7. 生命周期
onMounted(() => {})

// 8. 监听器
watch(() => route.params.id, () => {})
</script>
```

## 13. 参考资料

- [Vue 3 组合式API](https://vuejs.org/guide/extras/composition-api-faq.html)
- [路由架构设计](../../architecture/路由架构设计.md)
- [状态管理架构](../../architecture/状态管理架构.md)

---

**文档版本**：v1.0.0  
**创建时间**：2025年10月13日  
**最后更新**：2025年10月13日  
**维护者**：前端团队

