# 组件开发指南

## 1. 概述

本文档详细说明如何在青羽书城前端项目中开发Vue组件，包括从设计到测试的完整流程。

### 1.1 组件开发流程

```
需求分析 → 组件设计 → 编写代码 → 编写测试 → 文档编写 → Code Review → 集成使用
```

## 2. 组件设计

### 2.1 需求分析

在开发组件前，先明确以下问题：

**功能需求**：
- 组件要解决什么问题？
- 有哪些核心功能？
- 有哪些边界情况？

**使用场景**：
- 在哪些页面使用？
- 使用频率如何？
- 是否需要复用？

**性能要求**：
- 数据量有多大？
- 是否需要优化渲染？
- 是否需要懒加载？

### 2.2 组件API设计

设计组件的Props、Events、Slots：

```javascript
// 组件API设计示例
{
  // Props - 输入
  props: {
    book: Object,      // 书籍数据
    loading: Boolean,  // 加载状态
    size: String       // 尺寸: 'small' | 'medium' | 'large'
  },
  
  // Events - 输出
  events: {
    'click': (book) => {},        // 点击事件
    'favorite': (bookId) => {},   // 收藏事件
  },
  
  // Slots - 插槽
  slots: {
    default: {},           // 默认插槽
    footer: { book }       // 底部插槽，提供book数据
  }
}
```

## 3. 创建组件

### 3.1 组件文件结构

**单文件组件**（简单组件）：
```
src/components/BookCard.vue
```

**多文件组件**（复杂组件）：
```
src/components/BookCard/
├── index.vue           # 主组件
├── BookCard.test.js    # 测试文件
├── types.js           # 类型定义
└── README.md          # 组件文档
```

### 3.2 基础组件模板

```vue
<!-- src/components/BookCard.vue -->
<template>
  <div class="book-card" @click="handleClick">
    <!-- 封面 -->
    <div class="book-card__cover">
      <img 
        :src="book.cover" 
        :alt="book.title"
        loading="lazy"
        @error="handleImageError"
      />
    </div>
    
    <!-- 信息 -->
    <div class="book-card__info">
      <h3 class="book-card__title">{{ book.title }}</h3>
      <p class="book-card__author">{{ book.author }}</p>
      
      <!-- 默认插槽 -->
      <slot />
    </div>
    
    <!-- 底部插槽 -->
    <div class="book-card__footer">
      <slot name="footer" :book="book" />
    </div>
  </div>
</template>

<script setup>
import { computed } from 'vue'

/**
 * 书籍卡片组件
 * @description 展示书籍基本信息的卡片组件
 */

// Props定义
const props = defineProps({
  book: {
    type: Object,
    required: true,
    validator: (value) => {
      return value.id && value.title && value.cover
    }
  },
  size: {
    type: String,
    default: 'medium',
    validator: (value) => ['small', 'medium', 'large'].includes(value)
  }
})

// Events定义
const emit = defineEmits({
  'click': (book) => book && book.id,
  'favorite': (bookId) => typeof bookId === 'string'
})

// 计算属性
const cardClass = computed(() => {
  return `book-card book-card--${props.size}`
})

// 方法
const handleClick = () => {
  emit('click', props.book)
}

const handleImageError = (e) => {
  e.target.src = '/default-cover.jpg'
}

// 暴露给父组件的方法（可选）
defineExpose({
  refresh: () => {
    // 刷新组件
  }
})
</script>

<style scoped>
.book-card {
  border-radius: 8px;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.3s;
}

.book-card:hover {
  transform: translateY(-4px);
}

.book-card__cover {
  position: relative;
  padding-top: 133%; /* 3:4 比例 */
  background: #f5f5f5;
}

.book-card__cover img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.book-card__info {
  padding: 12px;
}

.book-card__title {
  font-size: 16px;
  font-weight: 500;
  margin: 0 0 8px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.book-card__author {
  font-size: 14px;
  color: #666;
  margin: 0;
}

/* 尺寸变体 */
.book-card--small .book-card__title {
  font-size: 14px;
}

.book-card--large .book-card__title {
  font-size: 18px;
}
</style>
```

## 4. 高级特性

### 4.1 使用Composition API

```vue
<script setup>
import { ref, computed, watch, onMounted } from 'vue'
import { useBookStore } from '@/stores/book'

const bookStore = useBookStore()

// 响应式数据
const isHovered = ref(false)
const isFavorited = ref(false)

// 计算属性
const displayPrice = computed(() => {
  return props.book.price ? `¥${props.book.price}` : '免费'
})

// 侦听器
watch(() => props.book.id, (newId) => {
  // 书籍ID变化时的处理
  checkFavoriteStatus(newId)
})

// 生命周期
onMounted(() => {
  checkFavoriteStatus(props.book.id)
})

// 方法
const checkFavoriteStatus = async (bookId) => {
  isFavorited.value = await bookStore.isFavorite(bookId)
}

const toggleFavorite = () => {
  isFavorited.value = !isFavorited.value
  emit('favorite', props.book.id, isFavorited.value)
}
</script>
```

### 4.2 使用Composables复用逻辑

```javascript
// composables/useBookCard.js
import { ref, computed } from 'vue'

export function useBookCard(book) {
  const isHovered = ref(false)
  const isLoading = ref(false)
  
  const displayInfo = computed(() => ({
    title: book.value.title,
    author: book.value.author,
    price: book.value.price ? `¥${book.value.price}` : '免费'
  }))
  
  const handleMouseEnter = () => {
    isHovered.value = true
  }
  
  const handleMouseLeave = () => {
    isHovered.value = false
  }
  
  return {
    isHovered,
    isLoading,
    displayInfo,
    handleMouseEnter,
    handleMouseLeave
  }
}
```

```vue
<script setup>
import { useBookCard } from '@/composables/useBookCard'

const props = defineProps({
  book: Object
})

const {
  isHovered,
  displayInfo,
  handleMouseEnter,
  handleMouseLeave
} = useBookCard(toRef(props, 'book'))
</script>
```

### 4.3 使用TypeScript（可选）

```vue
<script setup lang="ts">
interface Book {
  id: string
  title: string
  author: string
  cover: string
  price?: number
}

interface Props {
  book: Book
  size?: 'small' | 'medium' | 'large'
}

const props = withDefaults(defineProps<Props>(), {
  size: 'medium'
})

interface Emits {
  (e: 'click', book: Book): void
  (e: 'favorite', bookId: string): void
}

const emit = defineEmits<Emits>()
</script>
```

## 5. 组件样式

### 5.1 Scoped样式

```vue
<style scoped>
/* 组件内样式，不会影响其他组件 */
.book-card {
  /* 样式 */
}

/* 深度选择器 - 影响子组件 */
:deep(.child-component) {
  /* 样式 */
}

/* 插槽选择器 - 影响插槽内容 */
:slotted(.slot-content) {
  /* 样式 */
}

/* 全局选择器 */
:global(.global-class) {
  /* 全局样式 */
}
</style>
```

### 5.2 CSS变量

```vue
<style scoped>
.book-card {
  /* 使用CSS变量 */
  color: var(--book-card-text-color, #333);
  background: var(--book-card-bg-color, #fff);
  border-radius: var(--book-card-border-radius, 8px);
}

/* 响应式设计 */
@media (max-width: 768px) {
  .book-card {
    /* 移动端样式 */
  }
}
</style>
```

### 5.3 动态样式

```vue
<template>
  <div 
    class="book-card"
    :class="[
      `book-card--${size}`,
      { 'book-card--active': isActive }
    ]"
    :style="{
      background: backgroundColor,
      transform: `scale(${scale})`
    }"
  >
    <!-- 内容 -->
  </div>
</template>

<script setup>
const backgroundColor = computed(() => {
  return props.theme === 'dark' ? '#333' : '#fff'
})
</script>
```

## 6. 组件通信

### 6.1 Props传递

```vue
<!-- 父组件 -->
<template>
  <BookCard 
    :book="book"
    :size="size"
    :show-favorite="true"
  />
</template>

<!-- 子组件 -->
<script setup>
const props = defineProps({
  book: Object,
  size: String,
  showFavorite: Boolean
})
</script>
```

### 6.2 Events触发

```vue
<!-- 子组件 -->
<script setup>
const emit = defineEmits(['click', 'favorite'])

const handleClick = () => {
  emit('click', props.book)
}
</script>

<!-- 父组件 -->
<template>
  <BookCard 
    @click="handleBookClick"
    @favorite="handleFavorite"
  />
</template>
```

### 6.3 v-model双向绑定

```vue
<!-- 子组件 -->
<script setup>
const props = defineProps({
  modelValue: Boolean
})

const emit = defineEmits(['update:modelValue'])

const updateValue = (value) => {
  emit('update:modelValue', value)
}
</script>

<!-- 父组件 -->
<template>
  <BookCard v-model="isFavorited" />
</template>
```

### 6.4 Provide/Inject

```vue
<!-- 祖先组件 -->
<script setup>
import { provide } from 'vue'

const theme = ref('light')
provide('theme', theme)
</script>

<!-- 后代组件 -->
<script setup>
import { inject } from 'vue'

const theme = inject('theme')
</script>
```

## 7. 组件性能优化

### 7.1 使用v-memo

```vue
<template>
  <div v-for="book in books" :key="book.id" v-memo="[book.id, book.title]">
    <!-- 只在id或title变化时重新渲染 -->
    <BookCard :book="book" />
  </div>
</template>
```

### 7.2 异步组件

```javascript
import { defineAsyncComponent } from 'vue'

const BookCard = defineAsyncComponent(() =>
  import('./components/BookCard.vue')
)
```

### 7.3 使用shallowRef

```javascript
// 对于大型对象，使用shallowRef
const largeBook = shallowRef({
  id: '1',
  title: 'Book',
  chapters: [/* 大量数据 */]
})
```

## 8. 组件测试

### 8.1 单元测试

```javascript
// BookCard.test.js
import { mount } from '@vue/test-utils'
import { describe, it, expect } from 'vitest'
import BookCard from './BookCard.vue'

describe('BookCard', () => {
  const book = {
    id: '1',
    title: 'Test Book',
    author: 'Test Author',
    cover: '/cover.jpg'
  }

  it('renders book information', () => {
    const wrapper = mount(BookCard, {
      props: { book }
    })
    
    expect(wrapper.text()).toContain('Test Book')
    expect(wrapper.text()).toContain('Test Author')
  })

  it('emits click event when clicked', async () => {
    const wrapper = mount(BookCard, {
      props: { book }
    })
    
    await wrapper.trigger('click')
    
    expect(wrapper.emitted('click')).toBeTruthy()
    expect(wrapper.emitted('click')[0][0]).toEqual(book)
  })

  it('shows default image on error', async () => {
    const wrapper = mount(BookCard, {
      props: { book }
    })
    
    const img = wrapper.find('img')
    await img.trigger('error')
    
    expect(img.attributes('src')).toBe('/default-cover.jpg')
  })
})
```

### 8.2 快照测试

```javascript
it('matches snapshot', () => {
  const wrapper = mount(BookCard, {
    props: { book }
  })
  
  expect(wrapper.html()).toMatchSnapshot()
})
```

## 9. 组件文档

### 9.1 组件README

```markdown
# BookCard 组件

## 概述
书籍卡片展示组件，用于展示书籍的基本信息。

## 使用示例

\`\`\`vue
<template>
  <BookCard 
    :book="book"
    size="medium"
    @click="handleClick"
  />
</template>
\`\`\`

## API

### Props

| 属性 | 类型 | 默认值 | 必填 | 说明 |
|------|------|--------|------|------|
| book | Object | - | 是 | 书籍数据对象 |
| size | String | 'medium' | 否 | 卡片尺寸 |

### Events

| 事件名 | 参数 | 说明 |
|--------|------|------|
| click | (book: Object) | 点击卡片时触发 |
| favorite | (bookId: String) | 收藏时触发 |

### Slots

| 插槽名 | 作用域参数 | 说明 |
|--------|-----------|------|
| default | - | 默认插槽 |
| footer | { book } | 底部插槽 |
```

### 9.2 JSDoc注释

```javascript
/**
 * 书籍卡片组件
 * @component
 * @example
 * <BookCard :book="book" @click="handleClick" />
 */

/**
 * Props定义
 * @property {Object} book - 书籍数据
 * @property {String} size - 卡片尺寸 ('small' | 'medium' | 'large')
 */
const props = defineProps({
  book: Object,
  size: String
})
```

## 10. 最佳实践

### 10.1 组件设计原则

1. **单一职责**
   ```javascript
   // ✅ 好 - 只负责展示
   <BookCard :book="book" />
   
   // ❌ 不好 - 包含数据获取逻辑
   <BookCardWithData :bookId="id" />
   ```

2. **Props验证**
   ```javascript
   // ✅ 完整的验证
   props: {
     book: {
       type: Object,
       required: true,
       validator: (value) => value.id && value.title
     }
   }
   ```

3. **合理的默认值**
   ```javascript
   props: {
     size: {
       type: String,
       default: 'medium'
     },
     items: {
       type: Array,
       default: () => []  // 数组/对象用工厂函数
     }
   }
   ```

### 10.2 避免的反模式

```javascript
// ❌ 不要直接修改props
props.book.title = 'New Title'

// ✅ 使用计算属性或emit
const localBook = computed(() => ({ ...props.book }))
emit('update:book', { ...props.book, title: 'New Title' })

// ❌ 不要在模板中使用复杂逻辑
<div>{{ books.filter(b => b.rating > 4).map(b => b.title).join(', ') }}</div>

// ✅ 使用计算属性
const highRatedBooks = computed(() => 
  books.value.filter(b => b.rating > 4).map(b => b.title).join(', ')
)
```

## 11. 常见问题

### Q1: 组件之间如何共享状态？
```javascript
// 使用Pinia Store
import { useBookStore } from '@/stores/book'

const bookStore = useBookStore()
const book = computed(() => bookStore.currentBook)
```

### Q2: 如何实现组件懒加载？
```javascript
const BookCard = defineAsyncComponent({
  loader: () => import('./BookCard.vue'),
  loadingComponent: LoadingSpinner,
  delay: 200,
  timeout: 3000
})
```

### Q3: 如何处理组件错误？
```vue
<script setup>
import { onErrorCaptured } from 'vue'

onErrorCaptured((err, instance, info) => {
  console.error('组件错误:', err, info)
  return false  // 阻止错误继续传播
})
</script>
```

## 12. 参考资料

- [Vue 3 组件基础](https://vuejs.org/guide/essentials/component-basics.html)
- [组件架构设计](../../architecture/组件架构设计.md)
- [组件测试指南](../../testing/组件测试指南.md)

---

**文档版本**：v1.0.0  
**创建时间**：2025年10月13日  
**最后更新**：2025年10月13日  
**维护者**：前端团队

