# 状态管理指南

## 1. 概述

本文档详细说明如何在青羽书城前端项目中使用Pinia进行状态管理，包括Store创建、状态设计、Actions使用等内容。

### 1.1 为什么使用Pinia

- **TypeScript支持**：完整的类型推断
- **开发者体验**：直观的API，无需mutations
- **模块化设计**：自动的代码分割
- **Vue DevTools支持**：完整的调试体验
- **热模块替换**：开发时保持状态

## 2. Store基础

### 2.1 创建Store

```javascript
// stores/books.js
import { defineStore } from 'pinia'
import { booksAPI } from '@/api/books'

export const useBooksStore = defineStore('books', {
  // State
  state: () => ({
    // 书籍列表
    list: [],
    
    // 当前书籍详情
    detail: null,
    
    // 加载状态
    loading: false,
    
    // 错误信息
    error: null,
    
    // 分页信息
    pagination: {
      page: 1,
      size: 20,
      total: 0
    }
  }),

  // Getters
  getters: {
    // 是否有更多数据
    hasMore: (state) => {
      const { page, size, total } = state.pagination
      return page * size < total
    },
    
    // 获取指定ID的书籍
    getBookById: (state) => {
      return (id) => state.list.find(book => book.id === id)
    },
    
    // 推荐书籍（评分>4.5）
    recommendBooks: (state) => {
      return state.list.filter(book => book.rating >= 4.5)
    }
  },

  // Actions
  actions: {
    // 获取书籍列表
    async fetchBooks(params = {}) {
      this.loading = true
      this.error = null
      
      try {
        const response = await booksAPI.getList({
          page: this.pagination.page,
          size: this.pagination.size,
          ...params
        })
        
        this.list = response.list
        this.pagination.total = response.total
      } catch (error) {
        this.error = error.message
        throw error
      } finally {
        this.loading = false
      }
    },

    // 获取书籍详情
    async fetchBookDetail(id) {
      this.loading = true
      
      try {
        this.detail = await booksAPI.getDetail(id)
      } catch (error) {
        this.error = error.message
        throw error
      } finally {
        this.loading = false
      }
    },

    // 重置状态
    resetState() {
      this.list = []
      this.detail = null
      this.loading = false
      this.error = null
      this.pagination = { page: 1, size: 20, total: 0 }
    }
  }
})
```

### 2.2 使用Setup Store（推荐）

```javascript
// stores/books.js
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { booksAPI } from '@/api/books'

export const useBooksStore = defineStore('books', () => {
  // State (ref)
  const list = ref([])
  const detail = ref(null)
  const loading = ref(false)
  const error = ref(null)

  // Getters (computed)
  const hasBooks = computed(() => list.value.length > 0)
  const bookCount = computed(() => list.value.length)
  
  const getBookById = computed(() => {
    return (id) => list.value.find(book => book.id === id)
  })

  // Actions (functions)
  async function fetchBooks(params = {}) {
    loading.value = true
    error.value = null
    
    try {
      const response = await booksAPI.getList(params)
      list.value = response.list
    } catch (err) {
      error.value = err.message
      throw err
    } finally {
      loading.value = false
    }
  }

  async function fetchBookDetail(id) {
    loading.value = true
    
    try {
      detail.value = await booksAPI.getDetail(id)
    } catch (err) {
      error.value = err.message
      throw err
    } finally {
      loading.value = false
    }
  }

  function resetState() {
    list.value = []
    detail.value = null
    loading.value = false
    error.value = null
  }

  // 返回
  return {
    // State
    list,
    detail,
    loading,
    error,
    
    // Getters
    hasBooks,
    bookCount,
    getBookById,
    
    // Actions
    fetchBooks,
    fetchBookDetail,
    resetState
  }
})
```

## 3. 在组件中使用Store

### 3.1 基本使用

```vue
<script setup>
import { useBooksStore } from '@/stores/books'

const booksStore = useBooksStore()

// 直接访问state
console.log(booksStore.list)

// 调用actions
booksStore.fetchBooks()

// 访问getters
console.log(booksStore.hasMore)
</script>
```

### 3.2 解构响应式状态

```vue
<script setup>
import { storeToRefs } from 'pinia'
import { useBooksStore } from '@/stores/books'

const booksStore = useBooksStore()

// ✅ 使用storeToRefs解构，保持响应性
const { list, loading, error } = storeToRefs(booksStore)

// ✅ 直接解构actions（不需要storeToRefs）
const { fetchBooks, fetchBookDetail } = booksStore

// ❌ 错误：失去响应性
const { list: books } = booksStore
</script>

<template>
  <div v-if="loading">加载中...</div>
  <div v-else-if="error">{{ error }}</div>
  <div v-else>
    <div v-for="book in list" :key="book.id">
      {{ book.title }}
    </div>
  </div>
</template>
```

### 3.3 监听Store变化

```vue
<script setup>
import { watch } from 'vue'
import { useBooksStore } from '@/stores/books'
import { storeToRefs } from 'pinia'

const booksStore = useBooksStore()
const { list } = storeToRefs(booksStore)

// 监听特定状态
watch(list, (newList) => {
  console.log('书籍列表更新:', newList)
})

// 监听整个store
booksStore.$subscribe((mutation, state) => {
  console.log('Store变化:', mutation.type, state)
})
</script>
```

## 4. Store设计模式

### 4.1 用户Store

```javascript
// stores/user.js
import { defineStore } from 'pinia'
import { userAPI } from '@/api/user'

export const useUserStore = defineStore('user', {
  state: () => ({
    // 用户信息
    userInfo: null,
    
    // 认证token
    token: localStorage.getItem('token') || '',
    
    // 权限列表
    permissions: [],
    
    // 收藏的书籍ID列表
    favoriteBooks: []
  }),

  getters: {
    // 是否已登录
    isLoggedIn: (state) => !!state.token,
    
    // 用户名
    username: (state) => state.userInfo?.username || '游客',
    
    // 是否有某个权限
    hasPermission: (state) => {
      return (permission) => state.permissions.includes(permission)
    },
    
    // 是否收藏了某本书
    isFavorited: (state) => {
      return (bookId) => state.favoriteBooks.includes(bookId)
    }
  },

  actions: {
    // 登录
    async login(credentials) {
      try {
        const response = await userAPI.login(credentials)
        
        this.token = response.token
        this.userInfo = response.userInfo
        this.permissions = response.permissions
        
        // 保存token
        localStorage.setItem('token', response.token)
        
        return response
      } catch (error) {
        throw error
      }
    },

    // 登出
    async logout() {
      try {
        await userAPI.logout()
      } finally {
        this.token = ''
        this.userInfo = null
        this.permissions = []
        this.favoriteBooks = []
        
        localStorage.removeItem('token')
      }
    },

    // 获取用户信息
    async fetchUserInfo() {
      try {
        const userInfo = await userAPI.getUserInfo()
        this.userInfo = userInfo
        this.permissions = userInfo.permissions
      } catch (error) {
        throw error
      }
    },

    // 切换收藏
    async toggleFavorite(bookId) {
      const index = this.favoriteBooks.indexOf(bookId)
      
      if (index > -1) {
        // 取消收藏
        await userAPI.unfavoriteBook(bookId)
        this.favoriteBooks.splice(index, 1)
      } else {
        // 添加收藏
        await userAPI.favoriteBook(bookId)
        this.favoriteBooks.push(bookId)
      }
    }
  },

  // 持久化
  persist: {
    enabled: true,
    strategies: [
      {
        key: 'user',
        storage: localStorage,
        paths: ['token', 'userInfo', 'favoriteBooks']
      }
    ]
  }
})
```

### 4.2 应用Store

```javascript
// stores/app.js
import { defineStore } from 'pinia'

export const useAppStore = defineStore('app', {
  state: () => ({
    // 主题
    theme: 'light',
    
    // 侧边栏折叠状态
    sidebarCollapsed: false,
    
    // 设备类型
    device: 'desktop',
    
    // 面包屑
    breadcrumbs: [],
    
    // 全局加载状态
    globalLoading: false
  }),

  getters: {
    isMobile: (state) => state.device === 'mobile',
    isDark: (state) => state.theme === 'dark'
  },

  actions: {
    // 切换主题
    toggleTheme() {
      this.theme = this.theme === 'light' ? 'dark' : 'light'
      document.documentElement.setAttribute('data-theme', this.theme)
    },

    // 设置主题
    setTheme(theme) {
      this.theme = theme
      document.documentElement.setAttribute('data-theme', theme)
    },

    // 切换侧边栏
    toggleSidebar() {
      this.sidebarCollapsed = !this.sidebarCollapsed
    },

    // 设置设备类型
    setDevice(device) {
      this.device = device
    },

    // 设置面包屑
    setBreadcrumbs(breadcrumbs) {
      this.breadcrumbs = breadcrumbs
    },

    // 显示全局加载
    showLoading() {
      this.globalLoading = true
    },

    // 隐藏全局加载
    hideLoading() {
      this.globalLoading = false
    }
  },

  persist: {
    enabled: true,
    strategies: [
      {
        key: 'app',
        storage: localStorage,
        paths: ['theme', 'sidebarCollapsed']
      }
    ]
  }
})
```

### 4.3 阅读器Store

```javascript
// stores/reader.js
import { defineStore } from 'pinia'
import { readerAPI } from '@/api/reader'

export const useReaderStore = defineStore('reader', {
  state: () => ({
    // 当前章节
    currentChapter: null,
    
    // 章节内容
    chapterContent: '',
    
    // 阅读进度
    readingProgress: {
      bookId: '',
      chapterId: '',
      position: 0
    },
    
    // 阅读设置
    settings: {
      fontSize: 18,
      fontFamily: 'serif',
      lineHeight: 1.8,
      backgroundColor: '#f5f5f5',
      textColor: '#333'
    }
  }),

  getters: {
    // 当前进度百分比
    progressPercent: (state) => {
      if (!state.currentChapter) return 0
      return Math.round(
        (state.readingProgress.position / state.chapterContent.length) * 100
      )
    }
  },

  actions: {
    // 加载章节
    async loadChapter(bookId, chapterId) {
      try {
        const chapter = await readerAPI.getChapter(bookId, chapterId)
        
        this.currentChapter = chapter
        this.chapterContent = chapter.content
        this.readingProgress.bookId = bookId
        this.readingProgress.chapterId = chapterId
        
        // 加载保存的进度
        await this.loadProgress(bookId, chapterId)
      } catch (error) {
        throw error
      }
    },

    // 保存阅读进度
    async saveProgress(position) {
      this.readingProgress.position = position
      
      try {
        await readerAPI.saveProgress({
          bookId: this.readingProgress.bookId,
          chapterId: this.readingProgress.chapterId,
          position
        })
      } catch (error) {
        console.error('保存进度失败:', error)
      }
    },

    // 加载阅读进度
    async loadProgress(bookId, chapterId) {
      try {
        const progress = await readerAPI.getProgress(bookId, chapterId)
        if (progress) {
          this.readingProgress.position = progress.position
        }
      } catch (error) {
        console.error('加载进度失败:', error)
      }
    },

    // 更新设置
    updateSettings(settings) {
      this.settings = { ...this.settings, ...settings }
    },

    // 增大字体
    increaseFontSize() {
      if (this.settings.fontSize < 30) {
        this.settings.fontSize += 2
      }
    },

    // 减小字体
    decreaseFontSize() {
      if (this.settings.fontSize > 12) {
        this.settings.fontSize -= 2
      }
    }
  },

  persist: {
    enabled: true,
    strategies: [
      {
        key: 'reader',
        storage: localStorage,
        paths: ['settings', 'readingProgress']
      }
    ]
  }
})
```

## 5. Store组合

### 5.1 在Store中使用其他Store

```javascript
// stores/cart.js
import { defineStore } from 'pinia'
import { useUserStore } from './user'
import { useBooksStore } from './books'

export const useCartStore = defineStore('cart', {
  state: () => ({
    items: []
  }),

  actions: {
    async addToCart(bookId) {
      // 使用用户Store
      const userStore = useUserStore()
      
      if (!userStore.isLoggedIn) {
        throw new Error('请先登录')
      }

      // 使用书籍Store
      const booksStore = useBooksStore()
      const book = booksStore.getBookById(bookId)
      
      if (!book) {
        throw new Error('书籍不存在')
      }

      // 添加到购物车
      this.items.push({
        bookId: book.id,
        title: book.title,
        price: book.price,
        quantity: 1
      })
    }
  }
})
```

### 5.2 组合多个Store

```vue
<script setup>
import { useUserStore } from '@/stores/user'
import { useBooksStore } from '@/stores/books'
import { useCartStore } from '@/stores/cart'
import { storeToRefs } from 'pinia'

const userStore = useUserStore()
const booksStore = useBooksStore()
const cartStore = useCartStore()

const { isLoggedIn } = storeToRefs(userStore)
const { list: books } = storeToRefs(booksStore)
const { items: cartItems } = storeToRefs(cartStore)

const addToCart = async (bookId) => {
  try {
    await cartStore.addToCart(bookId)
    ElMessage.success('已加入购物车')
  } catch (error) {
    ElMessage.error(error.message)
  }
}
</script>
```

## 6. 状态持久化

### 6.1 使用pinia-plugin-persistedstate

```javascript
// main.js
import { createPinia } from 'pinia'
import piniaPluginPersistedstate from 'pinia-plugin-persistedstate'

const pinia = createPinia()
pinia.use(piniaPluginPersistedstate)

app.use(pinia)
```

```javascript
// stores/user.js
export const useUserStore = defineStore('user', {
  state: () => ({
    token: '',
    userInfo: null
  }),

  // 启用持久化
  persist: true
})
```

### 6.2 自定义持久化策略

```javascript
export const useUserStore = defineStore('user', {
  state: () => ({
    token: '',
    userInfo: null,
    preferences: {}
  }),

  persist: {
    // 自定义key
    key: 'user-store',
    
    // 使用sessionStorage
    storage: sessionStorage,
    
    // 只持久化部分状态
    paths: ['token', 'userInfo'],
    
    // 自定义序列化
    serializer: {
      serialize: JSON.stringify,
      deserialize: JSON.parse
    }
  }
})
```

## 7. 高级用法

### 7.1 订阅State变化

```javascript
const booksStore = useBooksStore()

// 订阅state变化
const unsubscribe = booksStore.$subscribe((mutation, state) => {
  console.log('变化类型:', mutation.type)
  console.log('State:', state)
  
  // mutation.type 可能的值：
  // - 'direct': 直接修改 state.xxx = yyy
  // - 'patch object': $patch({ xxx: yyy })
  // - 'patch function': $patch((state) => {})
})

// 取消订阅
unsubscribe()
```

### 7.2 订阅Actions

```javascript
const booksStore = useBooksStore()

booksStore.$onAction(({ name, args, after, onError }) => {
  console.log(`Action "${name}" 开始执行，参数:`, args)
  
  after((result) => {
    console.log(`Action "${name}" 执行成功，结果:`, result)
  })
  
  onError((error) => {
    console.log(`Action "${name}" 执行失败:`, error)
  })
})
```

### 7.3 重置Store

```javascript
const booksStore = useBooksStore()

// 重置到初始状态
booksStore.$reset()
```

### 7.4 批量更新State

```javascript
const booksStore = useBooksStore()

// 方式1：对象形式
booksStore.$patch({
  list: [...newBooks],
  loading: false,
  error: null
})

// 方式2：函数形式（推荐用于复杂更新）
booksStore.$patch((state) => {
  state.list.push(...newBooks)
  state.pagination.page += 1
  state.loading = false
})
```

## 8. 测试Store

### 8.1 单元测试

```javascript
// stores/__tests__/books.test.js
import { setActivePinia, createPinia } from 'pinia'
import { describe, it, expect, beforeEach, vi } from 'vitest'
import { useBooksStore } from '../books'
import { booksAPI } from '@/api/books'

// Mock API
vi.mock('@/api/books', () => ({
  booksAPI: {
    getList: vi.fn(),
    getDetail: vi.fn()
  }
}))

describe('Books Store', () => {
  beforeEach(() => {
    // 创建新的pinia实例
    setActivePinia(createPinia())
  })

  it('初始状态正确', () => {
    const store = useBooksStore()
    
    expect(store.list).toEqual([])
    expect(store.loading).toBe(false)
    expect(store.error).toBe(null)
  })

  it('fetchBooks成功', async () => {
    const store = useBooksStore()
    const mockBooks = [
      { id: '1', title: 'Book 1' },
      { id: '2', title: 'Book 2' }
    ]
    
    booksAPI.getList.mockResolvedValue({
      list: mockBooks,
      total: 2
    })

    await store.fetchBooks()

    expect(store.list).toEqual(mockBooks)
    expect(store.loading).toBe(false)
    expect(store.error).toBe(null)
  })

  it('fetchBooks失败', async () => {
    const store = useBooksStore()
    const errorMessage = '网络错误'
    
    booksAPI.getList.mockRejectedValue(new Error(errorMessage))

    await expect(store.fetchBooks()).rejects.toThrow(errorMessage)
    expect(store.error).toBe(errorMessage)
    expect(store.loading).toBe(false)
  })

  it('getter正确计算', () => {
    const store = useBooksStore()
    
    store.list = [
      { id: '1', title: 'Book 1', rating: 4.8 },
      { id: '2', title: 'Book 2', rating: 4.3 }
    ]

    expect(store.recommendBooks).toHaveLength(1)
    expect(store.recommendBooks[0].id).toBe('1')
  })
})
```

## 9. 最佳实践

### 9.1 命名规范

```javascript
// ✅ 好的命名
const useUserStore = defineStore('user', {
  state: () => ({
    userInfo: null,          // 名词
    isLoggedIn: false,       // is/has前缀的布尔值
    loading: false,          // 动名词
    errorMessage: null       // 明确的错误信息
  })
})

// ❌ 不好的命名
const useUserStore = defineStore('user', {
  state: () => ({
    data: null,              // 太泛化
    flag: false,             // 不明确
    err: null                // 缩写
  })
})
```

### 9.2 状态设计

```javascript
// ✅ 扁平化状态
state: () => ({
  userId: '',
  userName: '',
  userEmail: ''
})

// ❌ 过度嵌套
state: () => ({
  user: {
    info: {
      basic: {
        id: '',
        name: ''
      }
    }
  }
})
```

### 9.3 Actions设计

```javascript
// ✅ 明确的职责
actions: {
  async fetchBooks() { /* ... */ },
  async fetchBookDetail(id) { /* ... */ },
  async createBook(data) { /* ... */ }
}

// ❌ 职责不清
actions: {
  async doSomething() { /* ... */ },
  async handleData() { /* ... */ }
}
```

### 9.4 错误处理

```javascript
actions: {
  async fetchBooks() {
    this.loading = true
    this.error = null
    
    try {
      const data = await booksAPI.getList()
      this.list = data
    } catch (error) {
      this.error = error.message
      // 抛出错误，让调用者处理
      throw error
    } finally {
      this.loading = false
    }
  }
}
```

## 10. 常见问题

### Q1: Store什么时候创建？
```javascript
// Store是惰性创建的，第一次使用时才会创建
const booksStore = useBooksStore()
```

### Q2: 如何在setup外使用Store？
```javascript
// 在路由守卫中
router.beforeEach((to, from) => {
  const userStore = useUserStore()
  if (!userStore.isLoggedIn) {
    return '/login'
  }
})
```

### Q3: 如何在非Vue文件中使用Store？
```javascript
// utils/auth.js
import { useUserStore } from '@/stores/user'

export function checkAuth() {
  const userStore = useUserStore()
  return userStore.isLoggedIn
}
```

## 11. 参考资料

- [Pinia官方文档](https://pinia.vuejs.org/)
- [状态管理架构](../../architecture/状态管理架构.md)
- [API集成指南](./API集成指南.md)

---

**文档版本**：v1.0.0  
**创建时间**：2025年10月13日  
**最后更新**：2025年10月13日  
**维护者**：前端团队

